# ==============================================================================================================================================
# PR-Notify-Caller
# ==============================================================================================================================================
#
# Lightweight workflow for managed repositories to trigger the centralized PR-Notification workflow in TO-Toolkit via repository_dispatch.
#
# This file is distributed automatically by TO-Toolkit's repo-management pipeline via Terraform file sync.
# Only edit this in TO-Toolkit repository (repo-baseline)
#
# ==============================================================================================================================================
# PREREQUISITES
# ==============================================================================================================================================
#
# Organization-level secrets:
#   - PR_NOTIFY_GH_APP_ID       (GitHub App ID for App-TO-PR-Notify)
#   - PR_NOTIFY_GH_APP_PRIV_KEY (GitHub App private key)
#
# ==============================================================================================================================================

name: "PR-Notify-Caller"

on:
  pull_request:
    types: [opened, edited]

jobs:
  dispatch-notification:
    name: 'Dispatch PR notification to TO-Toolkit'
    runs-on: ubuntu-latest
    if: >-
      github.event.action == 'opened' ||
      (github.event.action == 'edited' && github.event.changes.body)

    steps:
      # Gate: only proceed if "Final PR" checkbox is checked
      - name: 'Task: Check Final PR checkbox'
        id: check-final
        shell: bash
        run: |
          if [[ "${{ contains(github.event.pull_request.body, '- [x] Final PR') }}" != "true" ]]; then
            echo "::notice::Final PR checkbox not checked. Skipping notification."
            echo "final=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ "${{ github.event.action }}" == "edited" ]]; then
            if [[ "${{ contains(github.event.changes.body.from, '- [x] Final PR') }}" == "true" ]]; then
              echo "::notice::Final PR was already checked before this edit. Skipping duplicate."
              echo "final=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi
          echo "final=true" >> "$GITHUB_OUTPUT"

      - name: 'Task: Create GitHub App token'
        if: steps.check-final.outputs.final == 'true'
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.PR_NOTIFY_GH_APP_ID }}
          private-key: ${{ secrets.PR_NOTIFY_GH_APP_PRIV_KEY }}
          owner: KPN-Code-Hub
          repositories: TO-Toolkit

      - name: 'Task: Dispatch to TO-Toolkit'
        if: steps.check-final.outputs.final == 'true'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ steps.app-token.outputs.token }}
          repository: KPN-Code-Hub/TO-Toolkit
          event-type: pr-notification
          client-payload: >-
            {
              "pr_title": "${{ github.event.pull_request.title }}",
              "pr_number": "${{ github.event.pull_request.number }}",
              "pr_url": "${{ github.event.pull_request.html_url }}",
              "pr_author": "${{ github.event.pull_request.user.login }}",
              "pr_branch": "${{ github.event.pull_request.head.ref }}",
              "repo_name": "${{ github.repository }}",
              "repo_short_name": "${{ github.event.repository.name }}"
            }
